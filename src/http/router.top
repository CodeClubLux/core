/**

Send a typed request to the server
@query

```
type Routes either
    Hello(|string| -> Response)

query decoder string, Hello
```
*/

def end-response[T](x: T) Response =
    response{ body = json-stringify x }


def query[T,U: enum](fromJSON: |Any| -> T, expects: ||T| -> Response| -> U) T do
    let body = (post "query", json-stringify expects end-response).body
    parse-json fromJSON, body